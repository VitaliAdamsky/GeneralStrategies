<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мульти-Таймфрейм RSI</title>
    <!-- Подключение ECharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        :root {
            --bg-color: #1a1b26;
            --card-bg-color: #24283b;
            --text-color: #c0caf5;
            --header-color: #bb9af7;
            --border-color: #414868;
            --font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;

            /* Цвета для зон */
            --green-zone: #2ecc71;
            --red-zone: #e74c3c;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1600px;
        }

        .header,
        .chart-container,
        .upload-card {
            background-color: var(--card-bg-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .header h1 {
            color: var(--header-color);
            text-align: center;
            margin: 0;
        }

        .chart-box {
            width: 100%;
            height: 70vh;
        }

        .upload-card {
            text-align: center;
            padding: 40px;
        }

        .upload-card label {
            background-color: #82aaff;
            color: var(--bg-color);
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .upload-card label:hover {
            background-color: #9abdf5;
        }

        input[type="file"] {
            display: none;
        }

        #error {
            text-align: center;
            color: var(--red-zone);
            margin-top: 15px;
            display: none;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header">
            <h1>Средний RSI по Рынку (Все Таймфреймы)</h1>
        </div>

        <div id="upload-section" class="upload-card">
            <h2>Загрузите файл с данными</h2>
            <p>Пожалуйста, выберите ваш <code>market_breadth_rsi.json</code> файл для визуализации.</p>
            <label for="jsonFileInput">Выбрать файл</label>
            <input type="file" id="jsonFileInput" accept=".json">
            <p id="error"></p>
        </div>

        <div id="dashboard" style="display: none;" class="chart-container">
            <div id="main-chart" class="chart-box"></div>
        </div>
    </div>

    <script>
        // Исправлено: Цвета прописаны напрямую в JS для ECharts
        const TF_COLORS = {
            '4h': '#00BFFF',  // DeepSkyBlue
            '8h': '#FF4757',  // Яркий красный
            '12h': '#FFD700', // Gold
            '1d': '#2ED573'   // Яркий зеленый
        };

        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear().toString().slice(-2);
            const month = ('0' + (d.getMonth() + 1)).slice(-2);
            const day = ('0' + d.getDate()).slice(-2);
            const hours = ('0' + d.getHours()).slice(-2);
            const minutes = ('0' + d.getMinutes()).slice(-2);
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        document.getElementById('jsonFileInput').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    document.getElementById('upload-section').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    renderChart(data.data);
                } catch (err) {
                    const errorContainer = document.getElementById('error');
                    errorContainer.textContent = `Ошибка! Не удалось обработать файл. (${err.message})`;
                    errorContainer.style.display = 'block';
                }
            };
            reader.readAsText(file);
        });

        function renderChart(data) {
            const timeframes = Object.keys(data);
            const chartDom = document.getElementById('main-chart');
            const myChart = echarts.init(chartDom, 'dark');

            const seriesData = timeframes.map(tf => {
                return {
                    name: tf,
                    type: 'line',
                    data: data[tf].map(item => [item.date, item.avg_rsi]),
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 2.5
                    },
                    color: TF_COLORS[tf] // Теперь ECharts получит прямой HEX-код
                };
            });

            const option = {
                backgroundColor: 'transparent',
                legend: {
                    data: timeframes,
                    textStyle: {
                        color: 'var(--text-color)'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross', label: { backgroundColor: '#6a7985' } },
                    formatter: function (params) {
                        let tooltipText = formatDate(params[0].axisValue);
                        params.forEach(param => {
                            tooltipText += `<br/><span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${param.color};"></span><strong>${param.seriesName}:</strong> ${param.value[1].toFixed(2)}`;
                        });
                        return tooltipText;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
                toolbox: { feature: { saveAsImage: {} } },
                xAxis: {
                    type: 'time',
                    boundaryGap: false,
                    axisLine: { lineStyle: { color: 'var(--border-color)' } },
                    axisLabel: {
                        formatter: (value) => formatDate(value)
                    }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    axisLine: { lineStyle: { color: 'var(--border-color)' } }
                },
                dataZoom: [{ type: 'inside', start: 0, end: 100 }, { start: 0, end: 100 }],
                series: [
                    ...seriesData,
                    {
                        type: 'line',
                        data: [],
                        markLine: {
                            silent: true,
                            symbol: 'none',
                            lineStyle: { type: 'dashed' },
                            data: [
                                { yAxis: 70, name: 'Перекупленность', label: { position: 'end', formatter: '70', color: 'var(--green-zone)', fontWeight: 'bold' }, lineStyle: { color: 'var(--green-zone)' } },
                                { yAxis: 30, name: 'Перепроданность', label: { position: 'end', formatter: '30', color: 'var(--red-zone)', fontWeight: 'bold' }, lineStyle: { color: 'var(--red-zone)' } },
                                { yAxis: 50, name: 'Центр', lineStyle: { color: 'var(--border-color)' } }
                            ]
                        }
                    }
                ]
            };

            myChart.setOption(option);
            window.addEventListener('resize', () => myChart.resize());
        }
    </script>
</body>

</html>