<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ширина Рынка по Скорости KAMA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        :root {
            --bg-color: #1a1b26;
            --card-bg-color: #24283b;
            --text-color: #c0caf5;
            --header-color: #bb9af7;
            --border-color: #414868;
            --font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            --red-color: #f7768e;
            --green-color: #9ece6a;
            --blue-color: #7aa2f7;
            --active-tab-color: #bb9af7;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1600px;
        }

        .header,
        .chart-container,
        .upload-card {
            background-color: var(--card-bg-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .header h1 {
            color: var(--header-color);
            text-align: center;
            margin: 0;
        }

        .chart-box {
            width: 100%;
            height: 70vh;
        }

        .upload-card {
            text-align: center;
            padding: 40px;
        }

        .upload-card label {
            background-color: var(--blue-color);
            color: var(--bg-color);
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .upload-card label:hover {
            background-color: #9abdf5;
        }

        input[type="file"] {
            display: none;
        }

        #error {
            text-align: center;
            color: var(--red-color);
            margin-top: 15px;
            display: none;
        }

        .tabs {
            display: flex;
            margin-bottom: -1px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            background-color: #2a2f4a;
        }

        .tab.active {
            background-color: var(--card-bg-color);
            border-bottom: 1px solid var(--card-bg-color);
            color: var(--active-tab-color);
            font-weight: bold;
        }

        #meta-info {
            text-align: center;
            font-size: 0.9em;
            margin-bottom: 15px;
            opacity: 0.8;
        }
    </style>
</head>

<body>

    <div class="container">
        <div id="upload-section" class="upload-card">
            <h2>Визуализатор Ширины Рынка (Скорость KAMA)</h2>
            <p>Пожалуйста, выберите ваш <code>market_breadth_kama_speed.json</code> файл для визуализации.</p>
            <label for="jsonFileInput">Выбрать файл</label>
            <input type="file" id="jsonFileInput" accept=".json">
            <p id="error"></p>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="header">
                <h1 id="main-title">Ширина Рынка по Скорости KAMA</h1>
                <p id="meta-info"></p>
            </div>
            <div class="tabs" id="tabs-container"></div>
            <div class="chart-container">
                <div id="main-chart" class="chart-box"></div>
            </div>
        </div>
    </div>

    <script>
        let fullData = null;
        let myChart = null;

        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear().toString().slice(-2);
            const month = ('0' + (d.getMonth() + 1)).slice(-2);
            const day = ('0' + d.getDate()).slice(-2);
            const hours = ('0' + d.getHours()).slice(-2);
            const minutes = ('0' + d.getMinutes()).slice(-2);
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        document.getElementById('jsonFileInput').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    fullData = JSON.parse(e.target.result);
                    document.getElementById('upload-section').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    setupDashboard();
                } catch (err) {
                    const errorContainer = document.getElementById('error');
                    errorContainer.textContent = `Ошибка! Не удалось обработать файл. (${err.message})`;
                    errorContainer.style.display = 'block';
                }
            };
            reader.readAsText(file);
        });

        function setupDashboard() {
            const meta = fullData.meta;
            const timeframes = Object.keys(fullData.data);
            const tabsContainer = document.getElementById('tabs-container');
            tabsContainer.innerHTML = ''; // Clear tabs

            document.getElementById('meta-info').innerText = `KAMA(${meta.kama_config.period}, ${meta.kama_config.fast}, ${meta.kama_config.slow}) | Топ-${meta.top_n_coins_per_tf} монет | История: ${meta.history_days} дней`;

            timeframes.forEach((tf, index) => {
                const tab = document.createElement('div');
                tab.className = 'tab';
                tab.textContent = tf;
                tab.dataset.tf = tf;
                if (index === 0) {
                    tab.classList.add('active');
                }
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    renderChart(tf);
                });
                tabsContainer.appendChild(tab);
            });

            const chartDom = document.getElementById('main-chart');
            myChart = echarts.init(chartDom, 'dark');
            window.addEventListener('resize', () => myChart.resize());

            if (timeframes.length > 0) {
                renderChart(timeframes[0]);
            }
        }

        function renderChart(timeframe) {
            const data = fullData.data[timeframe];
            if (!data) return;

            const option = {
                backgroundColor: 'transparent',
                legend: {
                    top: 10,
                    data: ['% Fast', '% Slow'],
                    textStyle: { color: 'var(--text-color)' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross', label: { backgroundColor: '#6a7985' } },
                    formatter: function (params) {
                        let tooltipText = formatDate(params[0].axisValue);
                        params.forEach(param => {
                            if (param.value && param.value[1] != null) {
                                tooltipText += `<br/><span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${param.color};"></span><strong>${param.seriesName}:</strong> ${param.value[1].toFixed(2)}%`;
                            }
                        });
                        return tooltipText;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '15%', top: '15%', containLabel: true },
                toolbox: { feature: { saveAsImage: {} } },
                xAxis: {
                    type: 'time',
                    boundaryGap: false,
                    axisLine: { lineStyle: { color: 'var(--border-color)' } },
                    axisLabel: { formatter: (value) => formatDate(value) }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    axisLine: { lineStyle: { color: 'var(--border-color)' } },
                    axisLabel: { formatter: '{value}%' }
                },
                dataZoom: [{ type: 'inside', start: 0, end: 100 }, { start: 0, end: 100 }],
                series: [
                    {
                        name: '% Fast',
                        type: 'line',
                        data: data.map(item => [item.date, item.pct_speed_fast]),
                        smooth: true,
                        showSymbol: false,
                        color: '#9ece6a', // Яркий зеленый
                        lineStyle: { width: 2.5 }
                    },
                    {
                        name: '% Slow',
                        type: 'line',
                        data: data.map(item => [item.date, item.pct_speed_slow]),
                        smooth: true,
                        showSymbol: false,
                        color: '#f7768e', // Яркий красный
                        lineStyle: { width: 2.5 }
                    },
                    {
                        type: 'line',
                        data: [],
                        markLine: {
                            silent: true,
                            symbol: 'none',
                            lineStyle: { type: 'dashed' },
                            data: [
                                { yAxis: 70, name: 'Зона высокой волатильности', label: { position: 'end', formatter: '70%', color: '#9ece6a', fontWeight: 'bold' }, lineStyle: { color: '#9ece6a' } },
                                { yAxis: 50, name: 'Центр', label: { position: 'end', formatter: '50%' }, lineStyle: { color: 'var(--border-color)' } },
                                { yAxis: 30, name: 'Зона низкой волатильности', label: { position: 'end', formatter: '30%', color: '#f7768e', fontWeight: 'bold' }, lineStyle: { color: '#f7768e' } }
                            ]
                        }
                    }
                ]
            };

            myChart.setOption(option, true); // true - чтобы очистить предыдущий график
        }
    </script>
</body>

</html>